# ğŸš€ Cloudflare Workers åŠ¨æ€åå‘ä»£ç† v1.2

ä¸€ä¸ªç®€æ´ã€é«˜æ•ˆã€åŠŸèƒ½å¼ºå¤§çš„ Cloudflare Workers åå‘ä»£ç†æœåŠ¡ï¼Œæ”¯æŒé€šè¿‡ URL è·¯å¾„åŠ¨æ€æŒ‡å®šç›®æ ‡åœ°å€ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### åŸºç¡€åŠŸèƒ½
- ğŸ¯ **åŠ¨æ€ç›®æ ‡åŸŸå** - é€šè¿‡ URL è·¯å¾„æŒ‡å®šä»»æ„ç›®æ ‡åŸŸå
- ğŸ”„ **æ™ºèƒ½é‡å®šå‘** - è‡ªåŠ¨è·Ÿéšæœ€å¤š 5 æ¬¡é‡å®šå‘
- ğŸ”’ **å®Œæ•´ IP éšè—** - æ¸…ç† 14+ ä¸ªå®¢æˆ·ç«¯ç›¸å…³è¯·æ±‚å¤´
- ğŸ›¡ï¸ **å®‰å…¨ä¼˜åŒ–** - åŸŸåé»‘åå• + è·¯å¾„å®‰å…¨æ£€æŸ¥ + ç§æœ‰ IP æ£€æµ‹
- ğŸŒ **å®Œæ•´ CORS** - ç»Ÿä¸€çš„è·¨åŸŸèµ„æºå…±äº«æ”¯æŒ
- ğŸ‘¤ **å¯é€‰è®¤è¯** - æ”¯æŒç®€å•çš„ç”¨æˆ·è®¤è¯æœºåˆ¶
- ğŸ¨ **å‹å¥½ç•Œé¢** - ç²¾ç¾çš„åŠ¨æ€ä½¿ç”¨è¯´æ˜é¡µé¢

### v1.2 ç¼“å­˜ä¼˜åŒ– ğŸ†•
- âš¡ **æ™ºèƒ½ç¼“å­˜åˆ†ç±»** - æ ¹æ®å†…å®¹ç±»å‹è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç¼“å­˜ç­–ç•¥
- ğŸŒ **Edge Cache** - åˆ©ç”¨ Cloudflare è¾¹ç¼˜èŠ‚ç‚¹ç¼“å­˜
- ğŸ“¦ **é™æ€èµ„æºé•¿ç¼“å­˜** - JS/CSS/å›¾ç‰‡/å­—ä½“ç­‰ç¼“å­˜ 24 å°æ—¶
- ğŸ”„ **stale-while-revalidate** - åå°æ›´æ–°ç¼“å­˜ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥
- ğŸ“Š **ç¼“å­˜çŠ¶æ€å¤´** - å“åº”å¤´ä¸­åŒ…å«ç¼“å­˜ç±»å‹å’Œ TTL ä¿¡æ¯
- ğŸ¯ **æ¡ä»¶è¯·æ±‚æ”¯æŒ** - æ”¯æŒ If-None-Match/If-Modified-Since

## ğŸ“– ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬æ ¼å¼

```
# æ— è®¤è¯æ¨¡å¼
https://æ‚¨çš„åŸŸå/ç›®æ ‡åŸŸå/è·¯å¾„

# è®¤è¯æ¨¡å¼ï¼ˆå¯ç”¨ authUser åï¼‰
https://æ‚¨çš„åŸŸå/ç”¨æˆ·å/ç›®æ ‡åŸŸå/è·¯å¾„
```

### ä½¿ç”¨ç¤ºä¾‹

#### ç¤ºä¾‹ 1: ä»£ç† API è¯·æ±‚

```bash
# è®¿é—®
https://your-worker.workers.dev/api.github.com/users/octocat

# å®é™…ä»£ç†åˆ°
https://api.github.com/users/octocat
```

#### ç¤ºä¾‹ 2: ä»£ç†é™æ€èµ„æº

```bash
# è®¿é—®ï¼ˆè‡ªåŠ¨ä½¿ç”¨ 24 å°æ—¶ç¼“å­˜ï¼‰
https://your-worker.workers.dev/cdn.example.com/assets/style.css

# å®é™…ä»£ç†åˆ°
https://cdn.example.com/assets/style.css
```

#### ç¤ºä¾‹ 3: å¸¦æŸ¥è¯¢å‚æ•°

```bash
# è®¿é—®
https://your-worker.workers.dev/example.com/search?q=test&page=1

# å®é™…ä»£ç†åˆ°
https://example.com/search?q=test&page=1
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. éƒ¨ç½²åˆ° Cloudflare Workers

#### æ–¹æ³•ä¸€ï¼šé€šè¿‡ Dashboard

1. ç™»å½• [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. è¿›å…¥ **Workers & Pages**
3. ç‚¹å‡» **Create Application** â†’ **Create Worker**
4. å°† `_worker.js` çš„ä»£ç å¤åˆ¶ç²˜è´´åˆ°ç¼–è¾‘å™¨
5. ç‚¹å‡» **Save and Deploy**

#### æ–¹æ³•äºŒï¼šä½¿ç”¨ Wrangler CLI

```bash
# å®‰è£… Wrangler
npm install -g wrangler

# ç™»å½• Cloudflare
wrangler login

# éƒ¨ç½²
wrangler deploy
```

### 2. é…ç½®è‡ªå®šä¹‰åŸŸåï¼ˆå¯é€‰ï¼‰

1. åœ¨ Workers è®¾ç½®ä¸­ç‚¹å‡» **Triggers**
2. ç‚¹å‡» **Add Custom Domain**
3. è¾“å…¥æ‚¨çš„åŸŸå
4. ç­‰å¾… DNS é…ç½®ç”Ÿæ•ˆ

## âš™ï¸ é…ç½®é€‰é¡¹

ç¼–è¾‘ `_worker.js` é¡¶éƒ¨çš„ `CONFIG` å¯¹è±¡ï¼š

```javascript
const CONFIG = {
  // ç”¨æˆ·è®¤è¯ï¼ˆç•™ç©ºåˆ™ç¦ç”¨ï¼‰
  authUser: '',

  // é»˜è®¤åè®®
  defaultProtocol: 'https',

  // æœ€å¤§é‡å®šå‘æ¬¡æ•°
  maxRedirects: 5,

  // è¯·æ±‚è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
  requestTimeout: 30000,

  // ========== ç¼“å­˜é…ç½® ==========
  // é»˜è®¤ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰
  defaultCacheTTL: 3600,      // 1å°æ—¶

  // é™æ€èµ„æºç¼“å­˜æ—¶é—´
  staticCacheTTL: 86400,      // 24å°æ—¶

  // åŠ¨æ€å†…å®¹ç¼“å­˜æ—¶é—´
  dynamicCacheTTL: 300,       // 5åˆ†é’Ÿ

  // å¯ç”¨ Edge Cache
  enableEdgeCache: true,

  // é™æ€èµ„æºæ‰©å±•å
  staticExtensions: [
    '.js', '.css', '.png', '.jpg', '.jpeg', '.gif', '.ico', '.svg', '.webp',
    '.woff', '.woff2', '.ttf', '.eot', '.otf',
    '.mp3', '.mp4', '.webm', '.pdf', '.zip',
  ],

  // ä¸ç¼“å­˜çš„è·¯å¾„
  noCachePaths: [
    '/api/auth', '/api/login', '/api/logout',
    '/webhook', '/callback',
  ],

  // åŸŸåé»‘åå•
  blockedDomains: [...],

  // åŸŸåç™½åå•ï¼ˆç•™ç©ºå…è®¸æ‰€æœ‰ï¼‰
  allowedDomains: [],

  // å±é™©è·¯å¾„é»‘åå•
  blockedPaths: [...],
};
```

### é…ç½®è¯´æ˜

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `authUser` | string | `''` | ç”¨æˆ·è®¤è¯ï¼Œç•™ç©ºç¦ç”¨ |
| `defaultProtocol` | string | `'https'` | é»˜è®¤åè®® |
| `maxRedirects` | number | `5` | æœ€å¤§é‡å®šå‘æ¬¡æ•° |
| `requestTimeout` | number | `30000` | è¯·æ±‚è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰ |
| `defaultCacheTTL` | number | `3600` | é»˜è®¤ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰ |
| `staticCacheTTL` | number | `86400` | é™æ€èµ„æºç¼“å­˜ï¼ˆç§’ï¼‰ğŸ†• |
| `dynamicCacheTTL` | number | `300` | åŠ¨æ€å†…å®¹ç¼“å­˜ï¼ˆç§’ï¼‰ğŸ†• |
| `enableEdgeCache` | boolean | `true` | å¯ç”¨è¾¹ç¼˜ç¼“å­˜ ğŸ†• |
| `blockedDomains` | array | `[...]` | åŸŸåé»‘åå• |
| `allowedDomains` | array | `[]` | åŸŸåç™½åå• |

## ğŸ“Š æ™ºèƒ½ç¼“å­˜ç­–ç•¥

v1.2 ç‰ˆæœ¬å¼•å…¥äº†æ™ºèƒ½ç¼“å­˜åˆ†ç±»ç³»ç»Ÿï¼š

### ç¼“å­˜åˆ†ç±»

| å†…å®¹ç±»å‹ | ç¼“å­˜æ—¶é—´ | Cache-Control | è¯´æ˜ |
|---------|----------|---------------|------|
| é™æ€èµ„æº | 24å°æ—¶ | `public, max-age=86400, immutable` | JS/CSS/å›¾ç‰‡/å­—ä½“ |
| åª’ä½“æ–‡ä»¶ | 24å°æ—¶ | `public, max-age=86400` | éŸ³é¢‘/è§†é¢‘ |
| HTML é¡µé¢ | 5åˆ†é’Ÿ | `public, max-age=300, stale-while-revalidate=60` | ç½‘é¡µå†…å®¹ |
| API/JSON | 5åˆ†é’Ÿ | `public, max-age=300, stale-while-revalidate=30` | æ¥å£å“åº” |
| å…¶ä»–å†…å®¹ | 1å°æ—¶ | `public, max-age=3600` | é»˜è®¤ç­–ç•¥ |

### å“åº”å¤´ç¤ºä¾‹

```http
x-cache-ttl: 86400s
x-cache-type: static
cache-control: public, max-age=86400, immutable, s-maxage=86400
x-proxy-by: CF-Workers-Proxy-v1.2
x-response-time: 123ms
```

### ç¼“å­˜ç±»å‹è¯´æ˜

- `static` - é™æ€èµ„æºï¼ˆé•¿æœŸç¼“å­˜ï¼‰
- `media` - åª’ä½“æ–‡ä»¶ï¼ˆéŸ³è§†é¢‘ï¼‰
- `html` - HTML é¡µé¢
- `api` - API/JSON å“åº”
- `default` - é»˜è®¤ç¼“å­˜
- `no-cache` - é…ç½®çš„ä¸ç¼“å­˜è·¯å¾„
- `origin-no-cache` - æºç«™è®¾ç½®äº† no-store/private
- `error` - é”™è¯¯å“åº”ï¼ˆä¸ç¼“å­˜ï¼‰

### Edge Cache

å¯ç”¨ `enableEdgeCache` åï¼š
- è‡ªåŠ¨æ·»åŠ  `s-maxage` ç”¨äº CDN è¾¹ç¼˜ç¼“å­˜
- åˆ©ç”¨ Cloudflare å…¨çƒ 300+ èŠ‚ç‚¹åŠ é€Ÿ
- æ˜¾è‘—å‡å°‘å›æºè¯·æ±‚

### stale-while-revalidate

HTML å’Œ API å“åº”å¯ç”¨ SWRï¼š
- ç¼“å­˜è¿‡æœŸåï¼Œå…ˆè¿”å›æ—§å†…å®¹
- åå°å¼‚æ­¥æ›´æ–°ç¼“å­˜
- ç”¨æˆ·æ— æ„ŸçŸ¥ç­‰å¾…

## ğŸ”§ é«˜çº§é…ç½®

### å¥åº·æ£€æŸ¥ç«¯ç‚¹

```bash
curl https://your-domain.com/health
```

å“åº”ï¼š
```json
{
  "status": "healthy",
  "timestamp": "2026-01-03T01:00:00.000Z",
  "version": "1.2",
  "cache": {
    "edge": true,
    "defaultTTL": 3600,
    "staticTTL": 86400
  }
}
```

### å®‰å…¨é»‘åå•

é¢„è®¾ä»¥ä¸‹åŸŸåé»‘åå•ï¼š
- æœ¬åœ°å’Œå†…ç½‘åœ°å€
- å®¹å™¨é•œåƒä»“åº“ï¼ˆDocker Hub ç­‰ï¼‰
- äº‘æœåŠ¡å•†å†…éƒ¨æœåŠ¡ï¼ˆmetadata ç­‰ï¼‰
- é‡‘èæ”¯ä»˜æœåŠ¡
- æ”¿åºœæœºæ„åŸŸå
- IP æŸ¥è¯¢æœåŠ¡

### è·¯å¾„å®‰å…¨æ£€æŸ¥

è‡ªåŠ¨é˜»æ­¢ä»¥ä¸‹è·¯å¾„ï¼š
- `/.env`, `/.git` - é…ç½®æ–‡ä»¶
- `/admin`, `/phpmyadmin` - ç®¡ç†åå°
- `/.aws`, `/.ssh` - å‡­è¯æ–‡ä»¶
- `/../` - è·¯å¾„éå†

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### 1. API è·¨åŸŸä»£ç†

```javascript
// å‰ç«¯ç›´æ¥è°ƒç”¨ï¼ˆè§£å†³ CORSï¼‰
fetch('https://your-proxy.workers.dev/api.example.com/data')
```

### 2. é™æ€èµ„æºåŠ é€Ÿ

```html
<!-- åˆ©ç”¨ 24 å°æ—¶ç¼“å­˜åŠ é€Ÿ -->
<img src="https://your-proxy.workers.dev/cdn.example.com/image.jpg">
```

### 3. éšè—çœŸå® IP

æ‰€æœ‰è¯·æ±‚éƒ½é€šè¿‡ Cloudflare èŠ‚ç‚¹ï¼Œå®Œå…¨éšè—å®¢æˆ·ç«¯ IPã€‚

## ğŸ“ æ³¨æ„äº‹é¡¹

### Cloudflare Workers é™åˆ¶

| é™åˆ¶é¡¹ | å…è´¹ç‰ˆ | ä»˜è´¹ç‰ˆ |
|--------|--------|--------|
| æ¯å¤©è¯·æ±‚æ•° | 100,000 | æ— é™åˆ¶ |
| CPU æ—¶é—´ | 10ms | 50ms |

### å®‰å…¨å»ºè®®

- ğŸ” ç”Ÿäº§ç¯å¢ƒå¯ç”¨ `authUser`
- ğŸ“‹ é…ç½® `allowedDomains` ç™½åå•
- ğŸš« ä¿æŒé»˜è®¤çš„å®‰å…¨é»‘åå•
- âš ï¸ é¿å…ä»£ç†æ•æ„ŸæœåŠ¡

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜ 1: åŸŸåè¢«é˜»æ­¢

æ£€æŸ¥ `blockedDomains` é…ç½®ï¼Œç¡®è®¤ç›®æ ‡åŸŸåä¸åœ¨é»‘åå•ä¸­ã€‚

### é—®é¢˜ 2: ç¼“å­˜ä¸ç”Ÿæ•ˆ

æ£€æŸ¥å“åº”å¤´ï¼š
- `x-cache-type` - æŸ¥çœ‹ç¼“å­˜ç±»å‹
- `x-cache-ttl` - æŸ¥çœ‹ç¼“å­˜æ—¶é—´
- ç¡®è®¤ä¸åœ¨ `noCachePaths` ä¸­

### é—®é¢˜ 3: è¯·æ±‚è¶…æ—¶

- å¢åŠ  `requestTimeout` å€¼
- æ£€æŸ¥ç›®æ ‡æœåŠ¡å™¨å“åº”é€Ÿåº¦

## ğŸ“š ä»£ç ç»“æ„

```
_worker.js (v1.2)
â”œâ”€â”€ CONFIG                      # é…ç½®åŒº
â”œâ”€â”€ fetch handler               # ä¸»å¤„ç†å‡½æ•°
â”‚   â”œâ”€â”€ å¥åº·æ£€æŸ¥
â”‚   â”œâ”€â”€ è·¯å¾„è§£æ
â”‚   â”œâ”€â”€ å®‰å…¨éªŒè¯
â”‚   â”œâ”€â”€ ä»£ç†è¯·æ±‚
â”‚   â””â”€â”€ æ™ºèƒ½ç¼“å­˜ ğŸ†•
â””â”€â”€ è¾…åŠ©å‡½æ•°
    â”œâ”€â”€ getCacheConfig()        # ç¼“å­˜é…ç½® ğŸ†•
    â”œâ”€â”€ parseUpstreamUrl()
    â”œâ”€â”€ fetchWithTimeout()
    â”œâ”€â”€ fetchWithRedirect()
    â”œâ”€â”€ stripClientHeaders()
    â”œâ”€â”€ stripSecurityHeaders()
    â”œâ”€â”€ corsResponse()
    â”œâ”€â”€ isPrivateIP()
    â””â”€â”€ getUsageHTML()
```

## ğŸ”„ æ›´æ–°æ—¥å¿—

### v1.2 (ç¼“å­˜ä¼˜åŒ–ç‰ˆ) - 2026-01-03 ğŸ‰

**ç¼“å­˜å¢å¼º**
- âœ¨ æ–°å¢ï¼šæ™ºèƒ½ç¼“å­˜åˆ†ç±»ç³»ç»Ÿ
- âœ¨ æ–°å¢ï¼šé™æ€èµ„æº 24 å°æ—¶é•¿ç¼“å­˜
- âœ¨ æ–°å¢ï¼šEdge Cache è¾¹ç¼˜èŠ‚ç‚¹ç¼“å­˜
- âœ¨ æ–°å¢ï¼šstale-while-revalidate æ”¯æŒ
- âœ¨ æ–°å¢ï¼šç¼“å­˜çŠ¶æ€å“åº”å¤´
- âœ¨ æ–°å¢ï¼šæ¡ä»¶è¯·æ±‚æ”¯æŒ

**ä»£ç ä¼˜åŒ–**
- ğŸ—‘ï¸ ç§»é™¤ï¼šè¯·æ±‚ä½“å¤§å°é™åˆ¶ï¼ˆCloudflare å·²æœ‰é™åˆ¶ï¼‰
- ğŸ—‘ï¸ ç§»é™¤ï¼šä¸å¿…è¦çš„é™é€ŸåŠŸèƒ½
- ğŸ”§ ä¼˜åŒ–ï¼šç²¾ç®€é”™è¯¯å“åº”
- ğŸ”§ ä¼˜åŒ–ï¼šå¢åŠ æœ€å¤§é‡å®šå‘æ¬¡æ•°åˆ° 5 æ¬¡

### v1.1 (å®‰å…¨å¢å¼ºç‰ˆ) - 2026-01-02

- âœ¨ æ‰©å±•åŸŸåé»‘åå•
- âœ¨ è·¯å¾„å®‰å…¨æ£€æŸ¥
- âœ¨ ç§æœ‰ IP æ£€æµ‹
- âœ¨ å¥åº·æ£€æŸ¥ç«¯ç‚¹

### v1.0 (åˆå§‹ç‰ˆ) - 2026-01-02

- âœ¨ åˆå§‹ç‰ˆæœ¬å‘å¸ƒ

## ğŸ“œ è®¸å¯è¯

MIT License

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## ğŸ“® ç›¸å…³èµ„æº

- [Cloudflare Workers æ–‡æ¡£](https://developers.cloudflare.com/workers/)
- [Workers é™åˆ¶](https://developers.cloudflare.com/workers/platform/limits/)

## âš ï¸ å…è´£å£°æ˜

æœ¬é¡¹ç›®ä»…ä¾›å­¦ä¹ å’Œç ”ç©¶ä½¿ç”¨ã€‚ä½¿ç”¨æ—¶è¯·ï¼š

1. éµå®ˆç›®æ ‡ç½‘ç«™çš„æœåŠ¡æ¡æ¬¾
2. éµå®ˆå½“åœ°æ³•å¾‹æ³•è§„
3. ä¸è¦ç”¨äºéæ³•ç”¨é€”
4. ä½œè€…ä¸å¯¹ä½¿ç”¨æœ¬ä»£ç é€ æˆçš„ä»»ä½•åæœè´Ÿè´£

---

**â­ å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸€ä¸ª Starï¼**

**ğŸ”— é¡¹ç›®åœ°å€ï¼š** [https://github.com/Meibidi/Cloudflare-Proxy](https://github.com/Meibidi/Cloudflare-Proxy)
